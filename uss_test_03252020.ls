/PROG  USS_TEST_03252020
/ATTR
OWNER		= MNEDITOR;
COMMENT		= "";
PROG_SIZE	= 2434;
CREATE		= DATE 20-03-25  TIME 23:17:10;
MODIFIED	= DATE 20-04-08  TIME 05:17:20;
FILE_NAME	= ;
VERSION		= 0;
LINE_COUNT	= 127;
MEMORY_SIZE	= 2862;
PROTECT		= READ_WRITE;
TCD:  STACK_SIZE	= 0,
      TASK_PRIORITY	= 50,
      TIME_SLICE	= 0,
      BUSY_LAMP_OFF	= 0,
      ABORT_REQUEST	= 0,
      PAUSE_REQUEST	= 0;
DEFAULT_GROUP	= 1,*,*,*,*;
CONTROL_CODE	= 00000000 00000000;
/MN
   1:  CALL ZERO    ;
   2:  //R[6]=0    ;
   3:  R[7]=0    ;
   4:   ;
   5:  LBL[21] ;
   6:   ;
   7:  !ACTIVE USS ITERATOR ;
   8:  IF (R[6]<>3) THEN ;
   9:  R[6]=R[6]+1    ;
  10:  ELSE ;
  11:  R[6]=1    ;
  12:  ENDIF ;
  13:  !TURN OFF INACTIVE USS PWR ;
  14:  IF (R[6]=1) THEN ;
  15:  !kill uss 2 & 3 pwr ;
  16:  DO[33]=ON ;
  17:  DO[35]=OFF ;
  18:  DO[37]=OFF ;
  19:  ELSE ;
  20:  IF (R[6]=2) THEN ;
  21:  !kill uss 1 & 3 pwr ;
  22:  DO[33]=OFF ;
  23:  DO[35]=ON ;
  24:  DO[37]=OFF ;
  25:  ELSE ;
  26:  IF (R[6]=3) THEN ;
  27:  !kill uss 1 & 2 pwr ;
  28:  DO[33]=OFF ;
  29:  DO[35]=OFF ;
  30:  DO[37]=ON ;
  31:  ENDIF ;
  32:  ENDIF ;
  33:  ENDIF ;
  34:   ;
  35:   ;
  36:  !the following lines are hardcode ;
  37:  R[6]=3    ;
  38:  DO[37]=ON ;
  39:   ;
  40:   ;
  41:  !TRAVEL TO APPROACH ;
  42:L PR[3] 3000mm/sec FINE    ;
  43:   ;
  44:  !set trigger distance (in mm) ;
  45:  !(USS trig's before at this dist) ;
  46:  R[8]=1000    ;
  47:  PR[4,3]=((-1)*R[8]) ;
  48:  !conv MM to active USS pulses ;
  49:  IF (R[6]=1) THEN ;
  50:  R[3]=(65536-(R[8]*R[9]) ;
  51:  ELSE ;
  52:  IF (R[6]=2) THEN ;
  53:  R[3]=(65536-(R[8]*R[10]) ;
  54:  ELSE ;
  55:  IF (R[6]=3) THEN ;
  56:  R[3]=(65536-(R[8]*R[11])) ;
  57:  ENDIF ;
  58:  ENDIF ;
  59:  ENDIF ;
  60:  !set lower bound of trig window ;
  61:  R[12]=R[3]*.5    ;
  62:   ;
  63:   ;
  64:  !FAST DESCEND ;
  65:  !SETS USS NO TRIG FAULT DIST ;
  66:  //SKIP CONDITION R[13]=1    ;
  67:  MONITOR USSPULSEMON ;
  68:L PR[3] 250mm/sec FINE Offset,PR[4]    ;
  69:  MONITOR END USSPULSEMON ;
  70:  PR[6]=LPOS    ;
  71:  IF R[13]=1,JMP LBL[20] ;
  72:   ;
  73:  !DO IF NO USS TRIG ;
  74:  !MOVE TO FAIL POS ;
  75:L PR[7] 3000mm/sec FINE    ;
  76:  R[4]=9999.99    ;
  77:  JMP LBL[30] ;
  78:   ;
  79:  LBL[20] ;
  80:  PR[6]=LPOS    ;
  81:  !RETRACT FOR SLOW DESCEND ;
  82:L PR[6] 500mm/sec FINE Offset,PR[5]    ;
  83:   ;
  84:  !SLOW DESCEND ;
  85:L PR[3] 10mm/sec FINE Offset,PR[4]    ;
  86:  R[1]=0    ;
  87:  WAIT    .50(sec) ;
  88:  PR[6]=LPOS    ;
  89:  R[1]=PR[4,3]    ;
  90:   ;
  91:  IF R[6]=1,JMP LBL[23] ;
  92:  IF R[6]=2,JMP LBL[24] ;
  93:  IF R[6]=3,JMP LBL[25] ;
  94:   ;
  95:  !SLOW DESC USS-1 ;
  96:  LBL[23] ;
  97:  R[2]=GI[1]    ;
  98:  CALL UIT502USSTOMM    ;
  99:  JMP LBL[30] ;
 100:   ;
 101:  !SLOW DESC USS-2 ;
 102:  LBL[24] ;
 103:  R[2]=GI[2]    ;
 104:  CALL UIT508USSTOMM    ;
 105:  JMP LBL[30] ;
 106:   ;
 107:  !SLOW DESC USS-3 ;
 108:  LBL[25] ;
 109:  R[7]=R[7]+1    ;
 110:  R[2]=GI[3]    ;
 111:  CALL UBUSSTOMM    ;
 112:  JMP LBL[30] ;
 113:   ;
 114:   ;
 115:  LBL[30] ;
 116:  CALL LOGREG(R[5],SR[1],R[6],R[4],R[7]) ;
 117:   ;
 118:  IF (R[7]>=5000) THEN ;
 119:  JMP LBL[99] ;
 120:  ENDIF ;
 121:   ;
 122:  JMP LBL[21] ;
 123:   ;
 124:  !END PROGRAM ;
 125:  LBL[99] ;
 126:  CALL ZERO    ;
 127:  END ;
/POS
/END
